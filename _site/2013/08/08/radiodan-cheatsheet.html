<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Radiodan cheatsheet</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Radiodan Blog</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>Radiodan cheatsheet</h2>
<p class="meta">08 Aug 2013 by <a href="http://github.com/libbymiller">libbymiller</a></p>

<div class="post">
<p>I&#39;ve been working with Radiodan to make a radio that plays whatever is most popular on BBC radio. Dan&#39;s been 
helping me understand how best to use the Radiodan features. Here&#39;s the results of our initial discussions.</p>

<h2>Radiodan</h2>

<p>Radiodan is a Ruby library containing four main elements:</p>

<ul>
<li>player lib/radiodan/</li>
<li>builder lib/radiodan/middleware</li>
<li>event binding </li>
<li>logging</li>
</ul>

<p><br /></p>

<h2>Player</h2>

<p>This is currently a wrapper (&#39;adapter&#39;) for the MPD player so you can only create an MPD player instance, but 
others could be made (i.e. an iTunes wrapper) as long as they support play, pause, and add to playlist: it&#39;s a 
wrapper for the software that actually plays the audio. To create a player, see Builder below.</p>

<p>The main part of Player is Playlist, which is what you tell the player about to tell it what to play. The Playlist 
consists of a state [:play, :stop, :pause], a mode [:sequential, :resume, :random], repeat (default false), an 
array of tracks, which themselves contain a file / url, a position (default 0), seek (default 0) and volume 
(default 100%).</p>

<div class="highlight"><pre><code class="ruby"><span class="n">radio4</span> <span class="o">=</span> <span class="ss">Radiodan</span><span class="p">:</span><span class="ss">:Playlist</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">tracks</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
</code></pre></div>

<p>A Playlist is also sent back by the Player at regular intervals (currently every 0.5 sec). Radiodan checks the 
playlist it sent against the playlist it gets back, and changes the state of the player if they are inconsistent. 
So for example if state from MPD is :stop when the Playlist sent to it was :play, then radiodan sends a play 
command to MPD.</p>

<p>Example playlist returned:</p>

<div class="highlight"><pre><code class="ruby"><span class="o">&lt;</span><span class="ss">Radiodan</span><span class="p">:</span><span class="ss">:Playlist</span><span class="p">:</span><span class="mh">0x1fb95b8</span> <span class="vi">@state</span><span class="o">=</span><span class="ss">:play</span><span class="p">,</span> <span class="vi">@mode</span><span class="o">=</span><span class="ss">:sequential</span><span class="p">,</span> <span class="vi">@repeat</span><span class="o">=</span><span class="kp">false</span><span class="p">,</span> <span class="vi">@tracks</span><span class="o">=</span>
 <span class="o">[</span><span class="c1">#&lt;Radiodan::Track:0x1fb2808</span>
  <span class="c1">#@attributes=</span>
   <span class="p">{</span><span class="s2">&quot;file&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;http://....&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;BBC Radio 4&quot;</span><span class="p">,</span> <span class="s2">&quot;Pos&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;Id&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;2&quot;</span><span class="p">}</span>
  <span class="o">&gt;]</span><span class="p">,</span> 
<span class="vi">@position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
<span class="vi">@seek</span><span class="o">=</span><span class="mi">13</span><span class="o">.</span><span class="mo">073</span><span class="p">,</span> 
<span class="vi">@volume</span><span class="o">=</span><span class="mi">80</span><span class="o">&gt;</span>
</code></pre></div>

<p>To change the channel, you simply send it a new Playlist. Similarly for MP3s. MP3 will typically contain more 
metadata than streams in general. To access items of metadata from the Playlist, use e.g. player.playlist[&quot;Name&quot;].</p>

<p><br /></p>

<h2>Builder</h2>

<p>Builder is about creating and running ad-hoc components for the system, the &#39;middleware&#39;. To use it you create a class of your own with a &#39;call&#39; function. This function must be wrapped in a event machine block or it will block. You can see some existing examples of middleware in the radiodan Gem in lib/radiodan/middleware/ - e.g. panic.rb. Radiodan loops through all of these it knows about in order, calling the call function and passing it an instance of Player. </p>

<p>Here&#39;s an example of how to start Radiodan with a builder, and you can see the logger, adapter for MPD, the initial playlist and then two pieces of middleware, touch_file and panic.</p>

<div class="highlight"><pre><code class="ruby"><span class="n">radio</span> <span class="o">=</span> <span class="no">Radiodan</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">builder</span><span class="o">|</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">log</span>      <span class="no">STDOUT</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">adapter</span>  <span class="ss">:MPD</span><span class="p">,</span> <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="mi">6600</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">playlist</span> <span class="n">radio4</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">use</span>      <span class="ss">:touch_file</span><span class="p">,</span> <span class="ss">:dir</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">use</span>      <span class="ss">:panic</span><span class="p">,</span> <span class="ss">:duration</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="ss">:playlist</span> <span class="o">=&gt;</span> <span class="n">radio1</span>
<span class="k">end</span>
<span class="n">radio</span><span class="o">.</span><span class="n">start</span>
</code></pre></div>

<p><br /></p>

<h2>Event Binding</h2>

<p>Any part of the system can register an event with a key and a block to call when the event is triggered, like this:</p>

<div class="highlight"><pre><code class="ruby"><span class="vi">@player</span><span class="o">.</span><span class="n">register_event</span> <span class="ss">:panic</span> <span class="k">do</span>
      <span class="n">panic!</span>
<span class="k">end</span>
</code></pre></div>

<p>To trigger an event, do this with the key used earlier, and any value to pass to the block: </p>

<div class="highlight"><pre><code class="ruby"><span class="vi">@player</span><span class="o">.</span><span class="n">trigger_event</span> <span class="ss">:panic</span>
</code></pre></div>

<p>[Note: We are considering adding an :all event which captures all events and which can be passed to the web interface via Faye.]</p>

<p><br /></p>

<h2>Logger</h2>

<p>Logging is fairly self-explanatory. To create a logger, pass it to the builder as above. To use it, do this:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;panicing!&quot;</span>
</code></pre></div>

<p>You can see the complete example in <a href="https://github.com/radiodan/radiodan_example/blob/master/bin/start">radiodan_example</a></p>

</div>


            <div class="footer">
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
